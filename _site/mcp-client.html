<html lang="ja">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0-beta.2/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0-beta.2/mapbox-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" type="text/css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script src="https://kenji-shima.github.io/resource-files/polyline.js" type="module"></script>
<script src="https://kenji-shima.github.io/resource-files/utils.js"></script>
  <style>
  * {
  box-sizing: border-box;
}

table {
  border-collapse: collapse;
  width: 100%;
}

td,
th {
  border: 1px solid black;
  text-align: left;
  padding: 8px;
}

th {
  background-color: #f2f2f2;
}

h1 {
  font-size: 22px;
  margin: 0;
  font-weight: 400;
  line-height: 20px;
  padding: 20px 2px;
}

a {
  color: red;
  text-decoration: underline;
  cursor: pointer;
  font: 400 14px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
}

.map {
  position: absolute;
  /*left: 20%;*/
  width: 100%;
  top: 0;
  bottom: 0;
}

::-webkit-scrollbar {
  width: 3px;
  height: 3px;
  border-left: 0;
  background: rgba(0, 0, 0, 0.1);
}

::-webkit-scrollbar-track {
  background: none;
}

::-webkit-scrollbar-thumb {
  background: #fff;
  border-radius: 0;
}

.map-overlay-right {
  position: absolute;
  top: 20px;
  right: 20px;
  opacity: 0.8;
  background-color: black;
  color: white;
  opacity: 0.8;
  text-align: left;
  overflow: auto;
  border-radius: 3px;
  padding: 10px;
  font: 400 12px/22px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
  animation: slide-up 1s;
}

.title {
  font-weight: bold;
}

@keyframes slide-up {
  from {
    transform: translateY(100%);
  }

  to {
    transform: translateY(0%);
  }
}

@keyframes slide-right {
  from {
    transform: translateX(-100%);
  }

  to {
    transform: translateX(0%);
  }
}

a.boxclose {
  float: right;
  cursor: pointer;
  display: block;
  box-sizing: border-box;
  width: 20px;
  height: 20px;
  border-width: 3px;
  border-style: solid;
  border-color: #605F61;
  border-radius: 100%;
  background: -webkit-linear-gradient(-45deg, transparent 0%, transparent 46%, white 46%, white 56%, transparent 56%, transparent 100%), -webkit-linear-gradient(45deg, transparent 0%, transparent 46%, white 46%, white 56%, transparent 56%, transparent 100%);
  background-color: #605F61;
  box-shadow: 0px 0px 5px 2px rgba(0, 0, 0, 0.5);
  transition: all 0.3s ease;
}

h3 {
  /*background: #0076D1;
  color: #fff;*/
  margin: 0;
  padding: 10px;
  border-radius: 3px 3px 0 0;
  font-weight: 700;
  /*margin-top: -15px;*/
}

body,
html {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: 'Open Sans', sans-serif;
  color: red;
}

h1 {
  margin: 0;
  position: relative;
  top: 50%;
  left: 0;
  right: 0;
  transform: translateY(-50%);
  text-align: center;
  font-size: 40px;
}

.map-overlay-legend {
  position: absolute;
  opacity: 0.8;
  top: 30;
  right: 0;
  background: #fff;
  margin-right: 20px;
  overflow: auto;
  border-radius: 3px;
  width: 300px;
  padding: 10px;
  font: 400 12px/22px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
  transition: transform .5s ease-in-out;
}

.mapboxgl-popup {
  padding-bottom: 10px;
  opacity: 0.8;
  width: 500px;
}

.mapboxgl-popup-content {
  padding-bottom: 10px;
  opacity: 0.8;
  width: fit-content;
}

.marker {
  border: none;
  cursor: pointer;
  height: 56px;
  width: 56px;
  background-image: url(../images/alert.png);
}

.blinking {
  -webkit-animation: blink .5s ease-in-out infinite alternate;
  -moz-animation: blink .5s ease-in-out infinite alternate;
  animation: blink .5s ease-in-out infinite alternate;
}

@-webkit-keyframes blink {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

@-moz-keyframes blink {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

@keyframes blink {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

a.replay {
  color: blue;
  text-decoration: underline;
  cursor: pointer;
  font: 400 18px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
}


.legend {
  position: absolute;
  bottom: 120px;
  right: 40px;
  background: black;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
  z-index: 1;
  width: 50%;
  opacity: 0.8;
}

.legend-title {
  font-size: 14px;
  text-align: center;
  margin-bottom: 5px;
  color: #000000;
}

.legend-scale {
  text-align: center;
}

.legend-bar {
  position: relative;
  height: 30px;
  background: linear-gradient(to right,
      rgba(80, 74, 154, 1),
      rgba(84, 172, 162, 1),
      rgba(193, 228, 148, 1),
      rgba(252, 244, 162, 1),
      rgba(251, 166, 91, 1),
      rgba(216, 66, 65, 1),
      rgba(143, 3, 58, 1));
  border: 1px solid #999;
  border-radius: 3px;
  margin-bottom: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 5px;
}

.label {
  font-size: 12px;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.hidden {
  display: none;
}

.map-overlay-bottom {
  position: absolute;
  bottom: 30px;
  right: 20px;
  left: 20px;
  background-color: black;
  color: white;
  opacity: 0.8;
  margin-right: 20px;
  font-family: Arial, sans-serif;
  overflow: auto;
  border-radius: 3px;
  padding: 10px;
  height: 80px;
}
.slider {
  position: relative;
  top: 20px;
  width: 100%;
}
.time {
  display: flex;
  justify-content: space-between;
  position: relative;
  width: 100%;
  top: 10px;
}
.time span {
  font-size: 12px;
  text-align: center;
}

#active-datetime {
  font-size: 14px;
  width: 100%;
  position: relative;
}

button {
  height: 14px;
  padding: 0 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 10px;
}

button:hover {
  background-color: #45a049;
}
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
  #chat { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
  #input { width: 70%; padding: 10px; }
  #send { width: 25%; padding: 10px; }
  .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
  .user { background-color: #e3f2fd; text-align: right; }
  .assistant { background-color: #f1f8e9; }
  .function { background-color: #fff3e0; font-size: 0.9em; }
</style>
</head>

<body>
    <h1>Mapbox AI Assistant</h1>
    <div id="chat"></div>
    <input type="text" id="input" placeholder="Ask about locations, directions, etc..." />
    <button id="send">Send</button>
<script>
  const OPENAI_API_KEY = ''; 
const MCP_SERVER_URL = 'http://localhost:3000/mcp';

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

let messages = [
    {
        role: "system",
        content: "You are a helpful assistant that can help with location-based queries using Mapbox services."
    }
];

// Function to call your MCP server
async function callMCPTool(toolName, arguments) {
    const response = await fetch(MCP_SERVER_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/event-stream'
        },
        body: JSON.stringify({
            jsonrpc: "2.0",
            id: Date.now(),
            method: "tools/call",
            params: {
                name: toolName,
                arguments: arguments
            }
        })
    });

    const result = await response.json();
    return result.result;
}

// Define available functions for OpenAI
const functions = [
    {
        name: "forward_geocode",
        description: "Find coordinates for a location",
        parameters: {
            type: "object",
            properties: {
                q: {
                    type: "string",
                    description: "The location to geocode"
                }
            },
            required: ["q"]
        }
    }
];

function addMessage(content, className) {
    const div = document.createElement('div');
    div.className = `message ${className}`;
    div.textContent = content;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
    const userMessage = input.value.trim();
    if (!userMessage) return;

    addMessage(userMessage, 'user');
    messages.push({ role: "user", content: userMessage });
    input.value = '';

    try {
        // Call OpenAI directly
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4",
                messages: messages,
                functions: functions,
                function_call: "auto"
            })
        });

        const data = await response.json();
        const responseMessage = data.choices[0].message;

        if (responseMessage.function_call) {
            // OpenAI wants to call a function
            const functionName = responseMessage.function_call.name;
            const functionArgs = JSON.parse(responseMessage.function_call.arguments);

            // Map to MCP tool names
            const toolMapping = {
                'forward_geocode': 'forward_geocode_tool'
            };

            const mcpToolName = toolMapping[functionName];

            if (mcpToolName) {
                // Call your MCP server
                const toolResult = await callMCPTool(mcpToolName, functionArgs);

                // Send function result back to OpenAI
                const secondResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [
                            ...messages,
                            responseMessage,
                            {
                                role: "function",
                                name: functionName,
                                content: JSON.stringify(toolResult)
                            }
                        ]
                    })
                });

                const secondData = await secondResponse.json();
                addMessage(secondData.choices[0].message.content, 'assistant');
                messages.push({ role: "assistant", content: secondData.choices[0].message.content });
            }
        } else {
            // Regular response
            addMessage(responseMessage.content, 'assistant');
            messages.push({ role: "assistant", content: responseMessage.content });
        }

    } catch (error) {
        addMessage('Error: ' + error.message, 'assistant');
    }
}

sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
