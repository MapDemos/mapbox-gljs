<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airport Layer Filter Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Mapbox Demos</h1> 
  </header>
  <main>
    <p>&lt;!DOCTYPE html&gt;</p>
<html>
<head>
  <meta charset="utf-8" />
  <title>Airport Layer Filter Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" type="text/css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script src="https://kenji-shima.github.io/resource-files/polyline.js" type="module"></script>
<script src="https://kenji-shima.github.io/resource-files/utils.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Layer filter panel */
    #layer-filter {
      position: absolute;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      min-width: 320px;
      max-width: 400px;
      z-index: 1000;
    }

    #layer-filter h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #layer-filter p {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }

    #layer-dropdown {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    #layer-dropdown:hover {
      border-color: #3b82f6;
    }

    #layer-dropdown:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Statistics display */
    #stats-container {
      margin-top: 20px;
      padding: 15px;
      background: #f0f9ff;
      border-radius: 8px;
      border: 1px solid #bfdbfe;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .stat-item:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      color: #1e40af;
      font-weight: 500;
    }

    .stat-value {
      color: #1e3a8a;
      font-weight: 700;
    }

    /* Selected airport info */
    #selected-airport {
      margin-top: 20px;
      padding: 15px;
      background: #fef3c7;
      border-radius: 8px;
      border: 1px solid #fcd34d;
      display: none;
    }

    #selected-airport.visible {
      display: block;
    }

    #selected-airport h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #92400e;
    }

    .airport-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .detail-label {
      color: #92400e;
      font-weight: 500;
    }

    .detail-value {
      color: #78350f;
      font-weight: 600;
      text-align: right;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Legend */
    #legend {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    #legend h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #374151;
      font-weight: 600;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Loading state */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      color: #3b82f6;
      font-size: 13px;
      font-style: italic;
      margin-top: 10px;
      display: flex;
      align-items: center;
    }

    /* Style switcher */
    #style-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      overflow: hidden;
      z-index: 1000;
    }

    .style-btn {
      padding: 10px 16px;
      border: none;
      background: white;
      color: #6b7280;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .style-btn:hover {
      background: #f3f4f6;
    }

    .style-btn.active {
      background: #3b82f6;
      color: white;
    }

    .style-btn:first-child {
      border-right: 1px solid #e5e7eb;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      #layer-filter {
        top: 10px;
        left: 10px;
        right: 10px;
        min-width: unset;
        padding: 15px;
      }

      #layer-filter h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      #layer-filter p {
        font-size: 13px;
        margin-bottom: 15px;
      }

      #style-switcher {
        top: 10px;
        right: 10px;
      }

      .style-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Style Switcher -->
  <div id="style-switcher">
    <button class="style-btn active" id="streets-btn">
      üó∫Ô∏è Streets
    </button>
    <button class="style-btn" id="satellite-btn">
      üõ∞Ô∏è Satellite
    </button>
  </div>

  <div id="layer-filter">
    <h2>üó∫Ô∏è Airport Layer Filter</h2>
    <p>Filter airports based on their best map layer. This shows what type of map feature each airport is most strongly associated with.</p>

    <div class="filter-group">
      <label for="layer-dropdown">Filter by Important Layer:</label>
      <select id="layer-dropdown">
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="filter-group" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
      <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #555;">
        <input type="checkbox" id="aeroway-toggle" checked="" style="margin-right: 8px;" />
        <span style="display: flex; align-items: center; gap: 6px;">
          <span style="display: inline-block; width: 16px; height: 16px; background: #ff6b35; opacity: 0.4; border-radius: 2px;"></span>
          Show aeroway areas (runways, taxiways, helipads)
        </span>
      </label>
    </div>

    <div id="stats-container">
      <div class="stat-item">
        <span class="stat-label">Total Airports:</span>
        <span class="stat-value" id="total-airports">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Filtered Airports:</span>
        <span class="stat-value" id="filtered-airports">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Selected Layer:</span>
        <span class="stat-value" id="selected-layer">All</span>
      </div>
    </div>

    <div id="selected-airport">
      <h3>Selected Airport</h3>
      <div class="airport-detail">
        <span class="detail-label">Name:</span>
        <span class="detail-value" id="airport-name">-</span>
      </div>
      <div class="airport-detail">
        <span class="detail-label">Type:</span>
        <span class="detail-value" id="airport-type">-</span>
      </div>
      <div class="airport-detail">
        <span class="detail-label">Layer:</span>
        <span class="detail-value" id="airport-layer">-</span>
      </div>
      <div class="airport-detail">
        <span class="detail-label">Distance:</span>
        <span class="detail-value" id="airport-distance">-</span>
      </div>
    </div>

    <div id="legend">
      <h4>Map Layers</h4>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #ff6b35; opacity: 0.4;"></div>
        <span>Aeroway Areas (Runways, Taxiways)</span>
      </div>
      <hr style="margin: 10px 0; border: none; border-top: 1px solid #e5e7eb;" />
      <h4>Airport Types</h4>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #10b981;"></div>
        <span>Heliport</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #3b82f6;"></div>
        <span>Small Airport</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #ea580c;"></div>
        <span>Medium Airport</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #dc2626;"></div>
        <span>Large Airport</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #0891b2;"></div>
        <span>Seaplane Base</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #a855f7;"></div>
        <span>Balloonport</span>
      </div>
    </div>

    <div id="status-container"></div>
  </div>

  <script>
    
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [139.7671, 35.6812], // Tokyo Station
      zoom: 5 // Wider view to see more airports
    });

    let allAirports = [];
    let currentPopup = null;
    let currentStyle = 'streets';
    let airportsData = null; // Store the GeoJSON data

    // Add navigation control
    map.addControl(new mapboxgl.NavigationControl());

    // Color mapping for all airport types
    const typeColors = {
      'large_airport': '#dc2626',     // Red - Major airports
      'medium_airport': '#ea580c',    // Orange - Regional airports
      'small_airport': '#3b82f6',     // Blue - Local airports
      'heliport': '#10b981',          // Green - Heliports
      'seaplane_base': '#0891b2',     // Cyan - Water-based
      'balloonport': '#a855f7',       // Purple - Balloon ports
      'closed': '#6b7280'             // Gray - Closed facilities
    };

    // Show status message
    function showStatus(message, isLoading = false) {
      const statusContainer = document.getElementById('status-container');
      if (message) {
        statusContainer.innerHTML = `
          <div class="status-message">
            ${message}
            ${isLoading ? '<span class="loading"></span>' : ''}
          </div>
        `;
      } else {
        statusContainer.innerHTML = '';
      }
    }

    // Update statistics
    function updateStats(total, filtered, layerName) {
      document.getElementById('total-airports').textContent = total;
      document.getElementById('filtered-airports').textContent = filtered;
      document.getElementById('selected-layer').textContent = layerName || 'All';
    }

    // Dynamically populate dropdown based on actual data
    function populateDropdown() {
      const dropdown = document.getElementById('layer-dropdown');

      // Count occurrences of each important_layer
      const layerCounts = {};
      allAirports.forEach(feature => {
        const layer = feature.properties.important_layer;
        layerCounts[layer] = (layerCounts[layer] || 0) + 1;
      });

      // Sort layers by count
      const sortedLayers = Object.entries(layerCounts)
        .sort((a, b) => b[1] - a[1]);

      // Group layers by category
      const aerowayLayers = [];
      const buildingLayers = [];
      const landuseLayers = [];
      const otherLayers = [];

      sortedLayers.forEach(([layer, count]) => {
        if (layer.startsWith('aeroway_')) {
          aerowayLayers.push([layer, count]);
        } else if (layer.startsWith('building_')) {
          buildingLayers.push([layer, count]);
        } else if (layer.startsWith('landuse_')) {
          landuseLayers.push([layer, count]);
        } else {
          otherLayers.push([layer, count]);
        }
      });

      // Build new dropdown HTML
      let dropdownHTML = `<option value="">All Airports (${allAirports.length})</option>`;

      if (aerowayLayers.length > 0) {
        dropdownHTML += '<optgroup label="Aeroway Features">';
        aerowayLayers.forEach(([layer, count]) => {
          const displayName = layer.replace('aeroway_', '').replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
          dropdownHTML += `<option value="${layer}">${displayName} (${count})</option>`;
        });
        dropdownHTML += '</optgroup>';
      }

      if (buildingLayers.length > 0) {
        dropdownHTML += '<optgroup label="Building Features">';
        buildingLayers.forEach(([layer, count]) => {
          const displayName = layer.replace('building_', '').replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
          dropdownHTML += `<option value="${layer}">${displayName} (${count})</option>`;
        });
        dropdownHTML += '</optgroup>';
      }

      if (landuseLayers.length > 0) {
        dropdownHTML += '<optgroup label="Landuse Features">';
        landuseLayers.forEach(([layer, count]) => {
          const displayName = layer.replace('landuse_', '').replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
          dropdownHTML += `<option value="${layer}">${displayName} (${count})</option>`;
        });
        dropdownHTML += '</optgroup>';
      }

      if (otherLayers.length > 0) {
        dropdownHTML += '<optgroup label="Other">';
        otherLayers.forEach(([layer, count]) => {
          const displayName = layer === 'NONE' ? 'No Features' :
            layer.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          dropdownHTML += `<option value="${layer}">${displayName} (${count})</option>`;
        });
        dropdownHTML += '</optgroup>';
      }

      dropdown.innerHTML = dropdownHTML;
    }

    // Function to add airport layers to the map
    function addAirportLayers() {
      if (!airportsData) return;

      // Add the GeoJSON as a source
      if (!map.getSource('airports')) {
        map.addSource('airports', {
          type: 'geojson',
          data: airportsData
        });
      }

      // Add the main airport layer if it doesn't exist
      if (!map.getLayer('airport-points')) {
        map.addLayer({
          id: 'airport-points',
          type: 'circle',
          source: 'airports',
          paint: {
            'circle-radius': [
              'interpolate',
              ['linear'],
              ['zoom'],
              3, 2,
              10, 6,
              15, 10
            ],
            'circle-color': ['get', 'color'],
            'circle-opacity': 0.8,
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff',
            'circle-stroke-opacity': 0.9
          }
        });
      }

      // Add highlighted layer if it doesn't exist
      if (!map.getLayer('airport-points-highlighted')) {
        map.addLayer({
          id: 'airport-points-highlighted',
          type: 'circle',
          source: 'airports',
          paint: {
            'circle-radius': [
              'interpolate',
              ['linear'],
              ['zoom'],
              3, 4,
              10, 10,
              15, 16
            ],
            'circle-color': ['get', 'color'],
            'circle-opacity': 1,
            'circle-stroke-width': 3,
            'circle-stroke-color': '#ffffff'
          },
          filter: ['==', ['get', 'ident'], ''] // Initially hide all
        });
      }

      // Add aeroway fill layer from Mapbox Streets v8 (after airport layers)
      if (!map.getLayer('aeroway-fill')) {
        // Add the composite source if not already added
        if (!map.getSource('composite')) {
          map.addSource('composite', {
            type: 'vector',
            url: 'mapbox://mapbox.mapbox-streets-v8'
          });
        }

        // Add aeroway fill layer with distinctive color
        // Insert it BELOW the airport points so points are visible on top
        map.addLayer({
          id: 'aeroway-fill',
          type: 'fill',
          source: 'composite',
          'source-layer': 'aeroway',
          paint: {
            'fill-color': '#ff6b35', // Bright orange-red, distinctive from other colors
            'fill-opacity': 0.4
          },
          layout: {
            'visibility': 'visible'
          }
        }, 'airport-points'); // Add below airport points layer
      }
    }

    // Style switching functionality
    document.getElementById('streets-btn').addEventListener('click', () => {
      if (currentStyle === 'streets') return;

      document.getElementById('streets-btn').classList.add('active');
      document.getElementById('satellite-btn').classList.remove('active');

      map.setStyle('mapbox://styles/mapbox/streets-v12');
      currentStyle = 'streets';
    });

    document.getElementById('satellite-btn').addEventListener('click', () => {
      if (currentStyle === 'satellite') return;

      document.getElementById('satellite-btn').classList.add('active');
      document.getElementById('streets-btn').classList.remove('active');

      map.setStyle('mapbox://styles/mapbox/satellite-streets-v12');
      currentStyle = 'satellite';
    });

    // Re-add layers after style change
    map.on('style.load', () => {
      if (airportsData || map.loaded()) {
        addAirportLayers();

        // Restore aeroway toggle state
        const aerowayToggle = document.getElementById('aeroway-toggle');
        if (aerowayToggle && map.getLayer('aeroway-fill')) {
          const visibility = aerowayToggle.checked ? 'visible' : 'none';
          map.setLayoutProperty('aeroway-fill', 'visibility', visibility);
        }
      }
    });

    // Handle aeroway layer toggle
    document.getElementById('aeroway-toggle').addEventListener('change', (e) => {
      const visibility = e.target.checked ? 'visible' : 'none';
      if (map.getLayer('aeroway-fill')) {
        map.setLayoutProperty('aeroway-fill', 'visibility', visibility);
      }
    });

    // Load the GeoJSON file
    map.on('load', async () => {
      console.log('Map loaded, loading airport data...');
      showStatus('Loading airports', true);

      try {
        // Load the airports_analysis.geojson file
        const response = await fetch('airports_analysis.geojson');
        const geojsonData = await response.json();

        console.log('GeoJSON loaded:', geojsonData);


        // Filter out closed airports and add color property
        const filteredFeatures = geojsonData.features.filter(feature =>
          feature.properties.airport_type !== 'closed'
        );

        filteredFeatures.forEach(feature => {
          const type = feature.properties.airport_type;
          feature.properties.color = typeColors[type] || '#6b7280';
        });

        // Create filtered GeoJSON
        const filteredGeoJSON = {
          type: 'FeatureCollection',
          features: filteredFeatures
        };

        // Store filtered airports and data
        allAirports = filteredFeatures;
        airportsData = filteredGeoJSON;

        // Dynamically populate dropdown based on actual data
        populateDropdown();

        // Add the airport layers
        addAirportLayers();

        // Update initial stats
        updateStats(allAirports.length, allAirports.length, 'All');

        showStatus('');
        console.log(`Loaded ${allAirports.length} airports`);

      } catch (error) {
        console.error('Error loading GeoJSON:', error);
        showStatus('Error loading airport data');
      }
    });

    // Handle dropdown selection with important_layer property
    document.getElementById('layer-dropdown').addEventListener('change', (e) => {
      const selectedValue = e.target.value;

      let filter;
      let filteredCount;
      let displayName;

      if (selectedValue === '') {
        // Show all airports
        filter = null;
        filteredCount = allAirports.length;
        displayName = 'All';
      } else {
        // Filter by important_layer value
        filter = ['==', ['get', 'important_layer'], selectedValue];
        filteredCount = allAirports.filter(f =>
          f.properties.important_layer === selectedValue
        ).length;

        // Format display name
        if (selectedValue === 'NONE') {
          displayName = 'No Features';
        } else {
          displayName = selectedValue.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
      }

      if (filter !== undefined) {
        map.setFilter('airport-points', filter);
        updateStats(allAirports.length, filteredCount, displayName);
      }

      // Clear any selected airport
      document.getElementById('selected-airport').classList.remove('visible');
      map.setFilter('airport-points-highlighted', ['==', ['get', 'ident'], '']);
    });

    // Add hover effects - show full information on mouseover
    let hoverTooltip = null;

    map.on('mouseenter', 'airport-points', (e) => {
      map.getCanvas().style.cursor = 'pointer';

      if (e.features.length > 0) {
        const feature = e.features[0];
        const props = feature.properties;

        // Update selected airport info panel
        const selectedDiv = document.getElementById('selected-airport');
        selectedDiv.classList.add('visible');

        document.getElementById('airport-name').textContent = props.name || 'Unknown';
        document.getElementById('airport-name').title = props.name || 'Unknown';
        document.getElementById('airport-type').textContent =
          (props.airport_type || 'unknown').replace(/_/g, ' ');
        document.getElementById('airport-layer').textContent =
          props.important_layer === 'NONE' ? 'No Features' :
          (props.important_layer || 'N/A').replace(/_/g, ' ');
        document.getElementById('airport-distance').textContent =
          `Features: ${props.features_count || 0}`;

        // Highlight the selected airport
        map.setFilter('airport-points-highlighted',
          ['==', ['get', 'ident'], props.ident]
        );

        // Remove previous tooltip if exists
        if (hoverTooltip) {
          hoverTooltip.remove();
        }

        // Build properties list HTML for popup
        let propertiesHtml = '';
        for (const [key, value] of Object.entries(props)) {
          if (key !== 'color' && value !== null && value !== undefined && value !== '') {
            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let formattedValue = value;

            // Special formatting for certain fields
            if (key === 'airport_type' || key === 'important_layer') {
              formattedValue = value === 'NONE' ? 'No Features' : value.replace(/_/g, ' ');
            }

            propertiesHtml += `<tr>
              <td style="font-weight: 600; padding-right: 10px; vertical-align: top;">${formattedKey}:</td>
              <td style="color: #666;">${formattedValue}</td>
            </tr>`;
          }
        }

        const popupContent = `
          <div style="padding: 8px; max-width: 300px;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #1e40af;">${props.name || 'Unknown'}</h3>
            <table style="font-size: 12px; line-height: 1.4;">
              ${propertiesHtml}
            </table>
          </div>
        `;

        // Show tooltip on hover with all properties
        hoverTooltip = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          offset: 25
        });

        hoverTooltip.setLngLat(feature.geometry.coordinates)
          .setHTML(popupContent)
          .addTo(map);
      }
    });

    map.on('mouseleave', 'airport-points', () => {
      map.getCanvas().style.cursor = '';

      // Hide the selected airport info panel
      document.getElementById('selected-airport').classList.remove('visible');

      // Clear the highlight
      map.setFilter('airport-points-highlighted', ['==', ['get', 'ident'], '']);

      // Remove hover tooltip
      if (hoverTooltip) {
        hoverTooltip.remove();
        hoverTooltip = null;
      }
    });

    // Add click handler to show ALL features at clicked point using queryRenderedFeatures
    let clickPopup = null;

    map.on('click', (e) => {
      // Remove previous popup if exists
      if (clickPopup) {
        clickPopup.remove();
        clickPopup = null;
      }

      // Query ALL features at the exact click point
      const allFeatures = map.queryRenderedFeatures(e.point);

      // Also query airport features in a small radius for better UX
      const airportFeatures = map.queryRenderedFeatures(
        [
          [e.point.x - 10, e.point.y - 10],
          [e.point.x + 10, e.point.y + 10]
        ],
        { layers: ['airport-points'] }
      );

      if (airportFeatures.length > 0 || allFeatures.length > 0) {
        // Group all features by layer
        const layerGroups = {};
        allFeatures.forEach(f => {
          const layer = f.sourceLayer || f.layer.id || 'unknown';
          if (!layerGroups[layer]) {
            layerGroups[layer] = [];
          }
          layerGroups[layer].push(f);
        });

        // Build airports section
        let airportsHtml = '';
        if (airportFeatures.length > 0) {
          const sortedAirports = airportFeatures.sort((a, b) => {
            const distA = Math.sqrt(
              Math.pow(e.lngLat.lng - a.geometry.coordinates[0], 2) +
              Math.pow(e.lngLat.lat - a.geometry.coordinates[1], 2)
            );
            const distB = Math.sqrt(
              Math.pow(e.lngLat.lng - b.geometry.coordinates[0], 2) +
              Math.pow(e.lngLat.lat - b.geometry.coordinates[1], 2)
            );
            return distA - distB;
          });

          sortedAirports.slice(0, 5).forEach(feature => {
            const props = feature.properties;
            const color = props.color || '#6b7280';

            // Build properties table
            let propsTable = '<table style="width: 100%; font-size: 10px; margin-top: 4px;">';
            Object.entries(props).forEach(([key, value]) => {
              if (key !== 'color' && value !== null && value !== undefined) {
                propsTable += `
                  <tr>
                    <td style="color: #6b7280; padding: 1px 4px 1px 0; vertical-align: top; font-weight: 500;">
                      ${key}:
                    </td>
                    <td style="color: #374151; padding: 1px 0; word-break: break-all;">
                      ${value}
                    </td>
                  </tr>
                `;
              }
            });
            propsTable += '</table>';

            airportsHtml += `
              <div style="margin: 6px 0; padding: 8px;
                          background: linear-gradient(90deg, ${color}15 0%, transparent 100%);
                          border-left: 3px solid ${color}; border-radius: 4px;">
                <div style="font-weight: 600; color: #1e40af; font-size: 12px; margin-bottom: 4px;">
                  ‚úàÔ∏è ${props.name || 'Unknown Airport'}
                </div>
                <details style="cursor: pointer;">
                  <summary style="font-size: 11px; color: #6b7280; user-select: none;">
                    View all ${Object.keys(props).length} properties
                  </summary>
                  ${propsTable}
                </details>
              </div>
            `;
          });
        }

        // Build other layers section
        let otherLayersHtml = '';
        const sortedLayers = Object.entries(layerGroups)
          .filter(([layer]) => layer !== 'airport-points' && layer !== 'airport-points-highlighted')
          .sort((a, b) => b[1].length - a[1].length);

        sortedLayers.slice(0, 8).forEach(([layer, features]) => {
          // Define colors for different layer types
          let layerColor = '#6b7280';
          if (layer.includes('road') || layer.includes('street')) layerColor = '#f59e0b';
          else if (layer.includes('water')) layerColor = '#0891b2';
          else if (layer.includes('building')) layerColor = '#8b5cf6';
          else if (layer.includes('landuse') || layer.includes('land')) layerColor = '#10b981';
          else if (layer.includes('poi')) layerColor = '#ec4899';
          else if (layer.includes('place')) layerColor = '#ef4444';

          // Get all unique properties across features in this layer
          const allProps = new Set();
          features.forEach(f => {
            if (f.properties) {
              Object.keys(f.properties).forEach(key => allProps.add(key));
            }
          });

          // Build features list with all properties
          let featuresHtml = '';
          features.slice(0, 3).forEach((feature, idx) => {
            const props = feature.properties || {};

            let propsTable = '<table style="width: 100%; font-size: 9px; margin-top: 2px;">';
            Object.entries(props).forEach(([key, value]) => {
              if (value !== null && value !== undefined && value !== '') {
                propsTable += `
                  <tr>
                    <td style="color: #9ca3af; padding: 1px 4px 1px 0; vertical-align: top;">
                      ${key}:
                    </td>
                    <td style="color: #4b5563; padding: 1px 0; word-break: break-all;">
                      ${typeof value === 'object' ? JSON.stringify(value) : value}
                    </td>
                  </tr>
                `;
              }
            });
            propsTable += '</table>';

            featuresHtml += `
              <details style="margin: 2px 0; cursor: pointer;">
                <summary style="font-size: 10px; color: #6b7280; padding: 2px 0; user-select: none;">
                  Feature ${idx + 1}: ${props.name || props.class || props.type || 'Unnamed'}
                </summary>
                ${propsTable}
              </details>
            `;
          });

          otherLayersHtml += `
            <div style="margin: 6px 0; padding: 8px; background: ${layerColor}08;
                        border-left: 3px solid ${layerColor}; border-radius: 4px;">
              <div style="font-weight: 600; color: #374151; font-size: 11px; margin-bottom: 4px;">
                ${layer}
                <span style="background: ${layerColor}20; color: ${layerColor};
                            padding: 1px 4px; border-radius: 3px; margin-left: 4px;
                            font-size: 10px;">${features.length} features</span>
              </div>
              ${featuresHtml}
              ${features.length > 3 ?
                `<div style="font-size: 9px; color: #9ca3af; margin-top: 4px; font-style: italic;">
                  + ${features.length - 3} more features...
                </div>` : ''
              }
            </div>
          `;
        });

        // Build the complete popup
        const popupContent = `
          <div style="padding: 12px; min-width: 350px; max-width: 500px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #1e40af;
                       border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
              üìç All Features at This Location
            </h3>

            ${airportFeatures.length > 0 ? `
              <div style="margin-bottom: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #1e40af;
                          font-weight: 600;">
                  ‚úàÔ∏è Airports (${airportFeatures.length})
                </h4>
                <div style="max-height: 200px; overflow-y: auto;">
                  ${airportsHtml}
                </div>
              </div>
            ` : ''}

            ${sortedLayers.length > 0 ? `
              <div>
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;
                          font-weight: 600;">
                  üó∫Ô∏è Other Map Layers (${Object.keys(layerGroups).length} total)
                </h4>
                <div style="max-height: 250px; overflow-y: auto;">
                  ${otherLayersHtml}
                </div>
              </div>
            ` : ''}

            <div style="text-align: center; color: #9ca3af; font-size: 10px;
                        margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
              Click location: ${e.lngLat.lat.toFixed(6)}, ${e.lngLat.lng.toFixed(6)}
            </div>
          </div>
        `;

        // Create and show the popup
        clickPopup = new mapboxgl.Popup({
          closeButton: true,
          closeOnClick: true,
          maxWidth: '550px'
        });

        clickPopup.setLngLat(e.lngLat)
          .setHTML(popupContent)
          .addTo(map);
      }
    });
  </script>
</body>
</html>

  </main>
  <footer>
    <p>¬© 2024, Mapbox Demos</p>
  </footer>
</body>
</html>